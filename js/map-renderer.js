// Generated by CoffeeScript 1.3.3
var _gSite;

_gSite = {};

_gSite.directionPathIndex = 0;

_gSite.viewRotation = true;

_gSite.mapInit = function() {
  _gSite.directionsDisplay = new google.maps.DirectionsRenderer();
  _gSite.directionsService = new google.maps.DirectionsService();
  _gSite.mapCanvas = document.getElementById("map-canvas");
  _gSite.mapPanoramaCanvas = document.getElementById("map-sv-canvas");
  _gSite.orgLatLng = new google.maps.LatLng(35.466487, 139.620795);
  _gSite.distLatLng = new google.maps.LatLng(35.293194, 139.57146);
  _gSite.gMapOptions = {
    zoom: 10,
    center: _gSite.orgLatLng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  _gSite.gPanoramaOptions = {
    position: _gSite.orgLatLng,
    pov: {
      heading: 0,
      pitch: 10,
      zoom: 0
    }
  };
  _gSite.map = new google.maps.Map(_gSite.mapCanvas, _gSite.gMapOptions);
  _gSite.orgPin = new google.maps.Marker({
    position: _gSite.orgLatLng,
    draggable: true,
    animation: google.maps.Animation.DROP,
    title: 'Start Point',
    icon: 'img/start.png',
    map: _gSite.map
  });
  _gSite.distPin = new google.maps.Marker({
    position: _gSite.distLatLng,
    draggable: true,
    animation: google.maps.Animation.DROP,
    title: 'Distination Point',
    icon: 'img/finish.png',
    map: _gSite.map
  });
  _gSite.directionsDisplay.setMap(_gSite.map);
  google.maps.event.addListener(_gSite.orgPin, 'dragend', function() {
    _gSite.orgLatLng = _gSite.orgPin.getPosition();
    return _gSite.gPanoramaOptions.position = _gSite.orgLatLng;
  });
  return google.maps.event.addListener(_gSite.distPin, 'dragend', function() {
    return _gSite.distLatLng = _gSite.distPin.getPosition();
  });
};

_gSite.renderNavigation = function() {
  _gSite.pin = new google.maps.Marker({
    position: _gSite.orgLatLng,
    map: _gSite.map
  });
  _gSite.directionRequest = {
    origin: _gSite.orgLatLng.toUrlValue(),
    destination: _gSite.distLatLng.toUrlValue(),
    travelMode: google.maps.TravelMode.DRIVING
  };
  _gSite.directionsService.route(_gSite.directionRequest, function(result, status) {
    if (status === google.maps.DirectionsStatus.OK) {
      return _gSite.directionsDisplay.setDirections(result);
    }
  });
  _gSite.panorama = new google.maps.StreetViewPanorama(_gSite.mapPanoramaCanvas, _gSite.gPanoramaOptions);
  _gSite.updatePanorama = function() {
    var currentPath, h, p, pos, poses, routes;
    if (_gSite.viewRotation) {
      h = _gSite.panorama.pov.heading;
      h += 0.1;
      if (h >= 360) {
        h = 0;
      }
      p = {
        heading: h,
        pitch: _gSite.panorama.pov.pitch,
        zoom: _gSite.panorama.pov.zoom
      };
      _gSite.panorama.setPov(p);
    }
    if (_gSite.directionsDisplay.directions) {
      routes = _gSite.directionsDisplay.directions.routes;
      if (routes.length > 0) {
        currentPath = routes[0].overview_path[_gSite.directionPathIndex / 100];
        if (currentPath && _gSite.directionPathIndex % 10 === 0 || _gSite.directionPathIndex / 100 === routes[0].overview_path.length - 1) {
          poses = currentPath.toUrlValue().split(",");
          pos = new google.maps.LatLng(poses[0] * 1, poses[1] * 1);
          _gSite.panorama.setPosition(pos);
          _gSite.map.setCenter(pos);
          _gSite.pin.setPosition(pos);
        }
        _gSite.directionPathIndex += 1;
      }
    }
    return requestAnimationFrame(_gSite.updatePanorama);
  };
  return _gSite.updatePanorama();
};

_gSite.hideMap = function(callback) {
  var that_;
  that_ = this;
  $("#map-canvas").css('opacity', .7).removeClass('overview');
  return setTimeout(function() {
    google.maps.event.trigger(_gSite.map, 'resize');
    _gSite.map.setZoom(15);
    _gSite.map.setCenter(_gSite.orgLatLng);
    return callback.call(that_);
  }, 700);
};

$(function() {
  _gSite.mapInit();
  $("#navigation-start").on('click', function() {
    return _gSite.hideMap(_gSite.renderNavigation);
  });
  return $("#map-sv-canvas").hover(function() {
    return _gSite.viewRotation = false;
  }, function() {
    return _gSite.viewRotation = true;
  });
});
